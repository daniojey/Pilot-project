{% extends "base.html" %}
{% load custom_tags %}
{% load static %}

{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'css/styles_tests.css' %}">   
<link rel="stylesheet" type="text/css" href="{% static 'css/question.css' %}">   

<body>
    <div class='base-container'>
        <div class='test-header'>
            <h2>{{ all_questions.current }}\{{ all_questions.all }}</h2>
           
            <span id="timer"></span>
        </div>

        <div class='test-category'>
            <label>Категорія питання ({% if current_question_group %}{{ current_question_group }}{% else %}Усі{% endif %})</label>
        </div>

        <div class='form-group'>
            <form id="test-form" method="POST" class='test-form' action="{% url 'tests:take_test' test.id %}">
                {% csrf_token %}
                {% for field in form %}
                {% if 'audio_answer_' in field.name %}
                <div class='audio-container'>
                    <p>{{ field.label_tag }}</p>
                    <audio controls id="audio_playback_{{ field.name|cut:'audio_answer_' }}"></audio>
                    <div>
                        <button type="button" onclick="startRecording({{ field.name|cut:'audio_answer_' }})">Почати запис</button>
                        <button type="button" onclick="stopRecording({{ field.name|cut:'audio_answer_' }})" disabled>Зупинити запис</button>
                    </div>
                    <!-- Скрытое поле для сохранения аудиофайла -->
                    {{ field }}
                </div>
                {% elif question.question_type == "MTCH" %}
                <div class="matching-container">
                    <div class="left-column">
                        {% if 'matching_left' in field.name %}
                        <div class="left-item" id="left_{{ field.name }}" data-left-item="{{ field.label }}">
                            {{ field.label }}  <!-- Показываем только текст -->
                        </div>
                        <div id="dropzone_{{ field.name }}" class="dropzone" ondrop="drop(event)" ondragover="allowDrop(event)" data-left-item="{{ field.name }}">
                            <!-- Скрытое поле для записи ответа -->
                            <input type="hidden" id="answer_{{ field.name }}" name="answer_{{ field.label }}" value="">
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="right-column">
                        {% if 'matching_right' in field.name %}
                        <div class="right-item" id="drag_{{ field.name }}" data-right-item="{{ field.label }}" draggable="true" ondragstart="drag(event)">
                            {{ field.label }}  <!-- Показываем только текст -->
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                {% elif question.question_type == "SC" %}
                <div class="form-radio">
                    <h3>{{ field.label_tag }}</h3>

                 <!-- Радио-кнопки, рендерим через цикл -->
                <div class="radio-answers">
                    {% for radio in field %}
                        <label class="custom-radio" data-value="{{ radio.data.value }}">
                            <!-- Скрытый input, он будет управляться через JS -->
                            {{ radio.tag }} 
                            
                            <!-- Кастомная визуализация радио-кнопки -->
                            <span class="custom-radio-circle"></span>
                            <span class="radio-label">{{ radio.choice_label }}</span>
                        </label>
                    {% endfor %}
                </div>
                </div>
                {% elif question.question_type == "MC" %}
                    <div class='form-checkbox'>
                        <h3>{{ field.label_tag }}</h3>

                        <div class='checkbox-answers'>
                            {% for choice in field %}
                                <label class="custom-checkbox">
                                    {{ choice.tag }}
                                    <span class="custom-checkbox-box"></span>
                                    {{ choice.choice_label }}
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                {% elif question.question_type == "INP" %}
                    <div class='form-input'>
                        <h3>{{ field.label_tag }}</h3>
                        

                        <div class='input-answer'>
                            {{ field|addattr:"placeholder:input" }}
                        </div>
                    </div>
                {% else %}
                {% endif %}
                
                
                {% endfor %}
                <input type="hidden" id="remaining_time" name="remaining_time" value="{{ remaining_time }}">
                <button type="submit" class='form-btn'>Далі</button>
            </form>
        </div>
        
    </div>
    
    {% comment %} <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Находим все элементы label, которые обертывают кастомные радио-кнопки
            const customRadios = document.querySelectorAll('.custom-radio');
        
            customRadios.forEach(radio => {
                radio.addEventListener('click', function() {
                    // Удаляем класс "active" со всех кастомных радио-кнопок
                    customRadios.forEach(r => r.classList.remove('active'));
                    
                    // Добавляем класс "active" к выбранной радио-кнопке
                    this.classList.add('active');
                    
                    // Находим внутри скрытый input[type="radio"] и "выбираем" его
                    const input = this.querySelector('input[type="radio"]');
                    input.checked = true;
                });
            });
        });
    </script> {% endcomment %}
    <script src="{% static 'js/radio_select.js' %}"></script>    
    <script src="{% static 'js/drag_and_drop.js' %}"></script>    
    <script src="{% static 'js/answer_recorder.js' %}"></script>    
    <script src="{% static 'js/test_timer.js' %}"></script>    
    {% comment %} <script>
        var countDownDuration = parseInt("{{ remaining_time }}", 10) * 1000;  // Остаток времени в миллисекундах
        
        if (isNaN(countDownDuration)) {
            console.error("Invalid duration:", "{{ remaining_time }}");
        } else {
            var timer = setInterval(function () {
                if (countDownDuration <= 0) {
                    clearInterval(timer);
                    document.getElementById("remaining_time").value = 0;
                    document.getElementById("test-form").submit();  // Автоматическая отправка формы
                }
                
                // Рассчитываем часы, минуты и секунды
                var hours = Math.floor((countDownDuration % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                var minutes = Math.floor((countDownDuration % (1000 * 60 * 60)) / (1000 * 60));
                var seconds = Math.floor((countDownDuration % (1000 * 60)) / 1000);
                
                var display = (hours > 0 ? hours + "h " : "") + minutes + "m " + seconds + "s ";
                
                document.getElementById('timer').innerText = display;
                
                // Уменьшаем время на одну секунду
                countDownDuration -= 1000;
                
                // Обновляем скрытое поле для отправки времени на сервер
                document.getElementById("remaining_time").value = countDownDuration / 1000;
            }, 1000);
        }
    </script> {% endcomment %}
</body>
{% endblock %}






