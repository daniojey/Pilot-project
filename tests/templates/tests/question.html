{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'css/styles_tests.css' %}">   

<head align="center">
    <h1 align="center">
        {{ test.name }}
    </h1>
</head>

<body>
    <h2>{{ all_questions.current }}\{{ all_questions.all }}</h2>
    <div id="timer" align='right'></div>
    
    <form id="test-form" method="POST" action="{% url 'tests:take_test' test.id %}">
        {% csrf_token %}
        {% for field in form %}
            {% if 'audio_answer_' in field.name %}
                <div>
                    <p>{{ field.label_tag }}</p>
                    <audio controls id="audio_playback_{{ field.name|cut:'audio_answer_' }}"></audio>
                    <div>
                        <button type="button" onclick="startRecording({{ field.name|cut:'audio_answer_' }})">Начать запись</button>
                        <button type="button" onclick="stopRecording({{ field.name|cut:'audio_answer_' }})" disabled>Остановить запись</button>
                    </div>
                    <!-- Скрытое поле для сохранения аудиофайла -->
                    {{ field }}
                </div>
    
            {% else %}
                <div class="form-group">
                    {{ field.label_tag }}
                    {{ field }}
                </div>
            {% endif %}
        {% endfor %}
        <button type="submit">Завершить тест</button>
    </form>
</body>

  <script>
    let mediaRecorder;
    let recordedChunks = [];

    function startRecording(questionId) {
        navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            mediaRecorder.onstop = function() {
                let blob = new Blob(recordedChunks, { type: 'audio/webm' });
                let url = URL.createObjectURL(blob);
                let audioElement = document.getElementById('audio_playback_' + questionId);
                audioElement.src = url;

                // Преобразуем в base64 и сохраняем в скрытое поле формы
                let reader = new FileReader();
                reader.onloadend = function() {
                    document.getElementById('id_audio_answer_' + questionId).value = reader.result;  // input id с префиксом 'id_'
                }
                reader.readAsDataURL(blob);

                recordedChunks = [];
            };
            mediaRecorder.start();
            document.querySelector('button[onclick="startRecording(' + questionId + ')"]').disabled = true;
            document.querySelector('button[onclick="stopRecording(' + questionId + ')"]').disabled = false;
        })
        .catch(error => {
            console.error("Error accessing microphone:", error);
        });
    }

    function stopRecording(questionId) {
        mediaRecorder.stop();
        document.querySelector('button[onclick="startRecording(' + questionId + ')"]').disabled = false;
        document.querySelector('button[onclick="stopRecording(' + questionId + ')"]').disabled = true;
    }
</script>


<script>
    var countDownDuration = parseInt("{{ test.duration.total_seconds }}", 10) * 1000;

    if (isNaN(countDownDuration)) {
        console.error("Invalid duration:", "{{ test.duration.total_seconds }}");
    } else {
        var timer = setInterval(function() {
            if (countDownDuration <= 0) {
                clearInterval(timer);
                window.location.href = "{% url 'tests:test_results' test.id %}";
            }
            var hours = Math.floor((countDownDuration % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((countDownDuration % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((countDownDuration % (1000 * 60)) / 1000);
            
            var display = hours > 0 ? hours + "h " : "";
            display += minutes + "m " + seconds + "s ";

            document.getElementById('timer').innerText = display;
            countDownDuration -= 1000;
        }, 1000);
    }

    document.oncontextmenu = function() {
        return false;
    }
    
    document.onkeydown = function(e) {
        if (e.ctrlKey && (e.key === 'c' || e.key === 'v' || e.key === 'x' || e.key === 'p')) {
            e.preventDefault();
        }
    }

</script>







