{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'css/styles_tests.css' %}">   

<head align="center">
    <h1 align="center">
        {{ test.name }}
    </h1>
</head>

<style>
    .matching-container {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }
    
    .left-column, .right-column {
        display: flex;
        align-items: center;
    }
    
    .left-item, .right-item {
        padding: 10px;
        margin: 0 10px;
        border: 2px solid #ccc;
        background-color: #f9f9f9;
        width: 150px;
        height: 50px;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .dropzone {
        width: 150px;
        height: 50px;
        border: 2px dashed #ccc;
        background-color: #f0f0f0;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .right-item[draggable="true"] {
        cursor: move;
    }
</style>

<body>
    <h2>{{ all_questions.current }}\{{ all_questions.all }}</h2>
    <h2>Категорія питання: {{ current_question_group }}</h2>
    <div id="timer" align='right'></div>
    
    <form id="test-form" method="POST" action="{% url 'tests:take_test' test.id %}">
        {% csrf_token %}
        {% for field in form %}
            {% if 'audio_answer_' in field.name %}
                <div>
                    <p>{{ field.label_tag }}</p>
                    <audio controls id="audio_playback_{{ field.name|cut:'audio_answer_' }}"></audio>
                    <div>
                        <button type="button" onclick="startRecording({{ field.name|cut:'audio_answer_' }})">Начать запись</button>
                        <button type="button" onclick="stopRecording({{ field.name|cut:'audio_answer_' }})" disabled>Остановить запись</button>
                    </div>
                    <!-- Скрытое поле для сохранения аудиофайла -->
                    {{ field }}
                </div>
            {% elif question.question_type == "MTCH" %}
                <div class="matching-container">
                    <div class="left-column">
                        {% if 'matching_left' in field.name %}
                            <div class="left-item">
                                {{ field.label }}  <!-- Показываем только текст -->
                            </div>
                            <div id="dropzone_{{ forloop.counter }}" class="dropzone" ondrop="drop(event)" ondragover="allowDrop(event)">
                                <!-- Сюда перетащить ответ -->
                            </div>
                        {% endif %}
                    </div>
    
                    <div class="right-column">
                        {% if 'matching_right' in field.name %}
                            <div class="right-item" id="drag_{{ forloop.counter }}" draggable="true" ondragstart="drag(event)">
                                {{ field.label }}  <!-- Показываем только текст -->
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="form-group">
                    {{ field.label_tag }}
                    {{ field }}
                </div>
            {% endif %}

            
        {% endfor %}
        <button type="submit">Підтвердити</button>
    </form>
</body>


<script>
    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.id);
    }

    function drop(ev) {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("text");
        var dropzone = ev.target;
        var rightItem = document.getElementById(data);

        if (dropzone.classList.contains('dropzone')) {
            dropzone.appendChild(rightItem);

            // Записываем значение в скрытое поле
            var leftId = dropzone.getAttribute('data-left-id');
            var rightId = rightItem.getAttribute('data-right-id');
            document.getElementById('answer_' + leftId).value = rightId;

            // Проверяем, записалось ли значение
            console.log('answer_' + leftId + ': ' + document.getElementById('answer_' + leftId).value);
        }
    }

    document.getElementById('test-form').addEventListener('submit', function(event) {
        event.preventDefault();  // Останавливаем стандартную отправку формы для проверки

        // Проверим содержимое всех скрытых полей
        const formData = new FormData(this);
        for (let [key, value] of formData.entries()) {
            console.log(key, value);
        }

        // Отправляем форму после проверки
        this.submit();
    });
</script>


  <script>
    let mediaRecorder;
    let recordedChunks = [];

    function startRecording(questionId) {
        navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            mediaRecorder.onstop = function() {
                let blob = new Blob(recordedChunks, { type: 'audio/webm' });
                let url = URL.createObjectURL(blob);
                let audioElement = document.getElementById('audio_playback_' + questionId);
                audioElement.src = url;

                // Преобразуем в base64 и сохраняем в скрытое поле формы
                let reader = new FileReader();
                reader.onloadend = function() {
                    document.getElementById('id_audio_answer_' + questionId).value = reader.result;  // input id с префиксом 'id_'
                }
                reader.readAsDataURL(blob);

                recordedChunks = [];
            };
            mediaRecorder.start();
            document.querySelector('button[onclick="startRecording(' + questionId + ')"]').disabled = true;
            document.querySelector('button[onclick="stopRecording(' + questionId + ')"]').disabled = false;
        })
        .catch(error => {
            console.error("Error accessing microphone:", error);
        });
    }

    function stopRecording(questionId) {
        mediaRecorder.stop();
        document.querySelector('button[onclick="startRecording(' + questionId + ')"]').disabled = false;
        document.querySelector('button[onclick="stopRecording(' + questionId + ')"]').disabled = true;
    }
</script>


<script>
    var countDownDuration = parseInt("{{ test.duration.total_seconds }}", 10) * 1000;

    if (isNaN(countDownDuration)) {
        console.error("Invalid duration:", "{{ test.duration.total_seconds }}");
    } else {
        var timer = setInterval(function() {
            if (countDownDuration <= 0) {
                clearInterval(timer);
                window.location.href = "{% url 'tests:test_results' test.id %}";
            }
            var hours = Math.floor((countDownDuration % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((countDownDuration % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((countDownDuration % (1000 * 60)) / 1000);
            
            var display = hours > 0 ? hours + "h " : "";
            display += minutes + "m " + seconds + "s ";

            document.getElementById('timer').innerText = display;
            countDownDuration -= 1000;
        }, 1000);
    }

    document.oncontextmenu = function() {
        return false;
    }
    
    document.onkeydown = function(e) {
        if (e.ctrlKey && (e.key === 'c' || e.key === 'v' || e.key === 'x' || e.key === 'p')) {
            e.preventDefault();
        }
    }

</script>







