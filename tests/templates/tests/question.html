{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'css/styles_tests.css' %}">   

<head align="center">
    <h1 align="center">
        {{ test.name }}
    </h1>
</head>


<body>
    <h2>{{ all_questions.current }}\{{ all_questions.all }}</h2>
    <h2>Категорія питання: {{ current_question_group }}</h2>
    <div>
        Час до закінчення тесту: <span id="timer"></span>
    </div>
    
    <form id="test-form" method="POST" action="{% url 'tests:take_test' test.id %}">
        {% csrf_token %}
        {% for field in form %}
            {% if 'audio_answer_' in field.name %}
                <div>
                    <p>{{ field.label_tag }}</p>
                    <audio controls id="audio_playback_{{ field.name|cut:'audio_answer_' }}"></audio>
                    <div>
                        <button type="button" onclick="startRecording({{ field.name|cut:'audio_answer_' }})">Почати запис</button>
                        <button type="button" onclick="stopRecording({{ field.name|cut:'audio_answer_' }})" disabled>Зупинити запис</button>
                    </div>
                    <!-- Скрытое поле для сохранения аудиофайла -->
                    {{ field }}
                </div>
            {% elif question.question_type == "MTCH" %}
                <div class="matching-container">
                    <div class="left-column">
                        {% if 'matching_left' in field.name %}
                        <div class="left-item" id="left_{{ field.name }}" data-left-item="{{ field.label }}">
                            {{ field.label }}  <!-- Показываем только текст -->
                        </div>
                        <div id="dropzone_{{ field.name }}" class="dropzone" ondrop="drop(event)" ondragover="allowDrop(event)" data-left-item="{{ field.name }}">
                            <!-- Скрытое поле для записи ответа -->
                            <input type="hidden" id="answer_{{ field.name }}" name="answer_{{ field.label }}" value="">
                        </div>
                        {% endif %}
                    </div>
            
                    <div class="right-column">
                        {% if 'matching_right' in field.name %}
                        <div class="right-item" id="drag_{{ field.name }}" data-right-item="{{ field.label }}" draggable="true" ondragstart="drag(event)">
                            {{ field.label }}  <!-- Показываем только текст -->
                        </div>
                        {% endif %}
                    </div>
                </div>
            
            
            {% else %}
                <div class="form-group">
                    {{ field.label_tag }}
                    {{ field }}
                </div>
            {% endif %}

            
        {% endfor %}
        <input type="hidden" id="remaining_time" name="remaining_time" value="{{ remaining_time }}">
        <button type="submit">Підтвердити</button>
    </form>

    <script>
        // Функция для обработки начала перетаскивания
        function drag(event) {
            var data = event.target.getAttribute('data-right-item');
            if (data) {
                event.dataTransfer.setData("text", event.target.id);  // Передаём ID элемента
                console.log("Начато перетаскивание элемента с данными:", data);
            } else {
                console.error("Ошибка: атрибут data-right-item пустой!");
            }
        }

        // Функция для разрешения сброса элемента
        function allowDrop(event) {
            event.preventDefault();  // Останавливаем стандартное поведение браузера
        }

        // Функция для обработки сброса элемента в dropzone
        function drop(event) {
            event.preventDefault();

            // Получаем ID элемента, который был перетащен
            var draggedElementId = event.dataTransfer.getData("text");
            var draggedElement = document.getElementById(draggedElementId);

            if (draggedElement) {
                var dropzone = event.target;

                // Перемещаем перетаскиваемый элемент в новую зону
                dropzone.appendChild(draggedElement);

                // Получаем значения левого и правого элемента
                var leftBlockId = dropzone.getAttribute('data-left-item');  // Получаем идентификатор левого элемента
                var rightBlockValue = draggedElement.getAttribute('data-right-item');  // Получаем значение правого элемента

                console.log("Сопоставлены элементы:", leftBlockId, "с", rightBlockValue);

                // Обновляем скрытое поле с результатом сопоставления
                var matchingInput = document.getElementById('answer_' + leftBlockId);  // Используем идентификатор левого элемента
                if (matchingInput) {
                    matchingInput.value = rightBlockValue;
                    console.log("Обновлено скрытое поле для POST-запроса:", matchingInput);
                } else {
                    console.error("Не удалось найти скрытое поле для:", leftBlockId);
                }
            } else {
                console.error("Перетаскиваемый элемент не найден:", draggedElementId);
            }
        }

    </script>
    
    
</body>





  <script>
    let mediaRecorder;
    let recordedChunks = [];

    function startRecording(questionId) {
        navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            mediaRecorder.onstop = function() {
                let blob = new Blob(recordedChunks, { type: 'audio/webm' });
                let url = URL.createObjectURL(blob);
                let audioElement = document.getElementById('audio_playback_' + questionId);
                audioElement.src = url;

                // Преобразуем в base64 и сохраняем в скрытое поле формы
                let reader = new FileReader();
                reader.onloadend = function() {
                    document.getElementById('id_audio_answer_' + questionId).value = reader.result;  // input id с префиксом 'id_'
                }
                reader.readAsDataURL(blob);

                recordedChunks = [];
            };
            mediaRecorder.start();
            document.querySelector('button[onclick="startRecording(' + questionId + ')"]').disabled = true;
            document.querySelector('button[onclick="stopRecording(' + questionId + ')"]').disabled = false;
        })
        .catch(error => {
            console.error("Error accessing microphone:", error);
        });
    }

    function stopRecording(questionId) {
        mediaRecorder.stop();
        document.querySelector('button[onclick="startRecording(' + questionId + ')"]').disabled = false;
        document.querySelector('button[onclick="stopRecording(' + questionId + ')"]').disabled = true;
    }
</script>


<script>
    var countDownDuration = parseInt("{{ remaining_time }}", 10) * 1000;  // Остаток времени в миллисекундах

    if (isNaN(countDownDuration)) {
        console.error("Invalid duration:", "{{ remaining_time }}");
    } else {
        var timer = setInterval(function() {
            if (countDownDuration <= 0) {
                clearInterval(timer);
                document.getElementById("remaining_time").value = 0;
                document.getElementById("test-form").submit();  // Автоматическая отправка формы
            }

            // Рассчитываем часы, минуты и секунды
            var hours = Math.floor((countDownDuration % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((countDownDuration % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((countDownDuration % (1000 * 60)) / 1000);
            
            var display = (hours > 0 ? hours + "h " : "") + minutes + "m " + seconds + "s ";

            document.getElementById('timer').innerText = display;

            // Уменьшаем время на одну секунду
            countDownDuration -= 1000;

            // Обновляем скрытое поле для отправки времени на сервер
            document.getElementById("remaining_time").value = countDownDuration / 1000;
        }, 1000);
    }
</script>







